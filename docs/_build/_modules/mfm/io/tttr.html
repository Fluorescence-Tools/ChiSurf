

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mfm.io.tttr &mdash; ChiSurf  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ChiSurf
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/use_cases.html">Use cases</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ChiSurf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mfm.io.tttr</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mfm.io.tttr</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tables</span>

<span class="kn">import</span> <span class="nn">mfm</span>


<span class="k">class</span> <span class="nc">Photon</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="n">ROUT</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt8Col</span><span class="p">()</span>
    <span class="n">TAC</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt32Col</span><span class="p">()</span>
    <span class="n">MT</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt64Col</span><span class="p">()</span>
    <span class="n">FileID</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt16Col</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Header</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="n">DINV</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt16Col</span><span class="p">()</span> <span class="c1"># DataInvalid,</span>
    <span class="n">NROUT</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt16Col</span><span class="p">()</span> <span class="c1"># Number of routing channels</span>
    <span class="n">MTCLK</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span> <span class="c1"># Macro Time clock</span>
    <span class="n">nTAC</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt16Col</span><span class="p">()</span>
    <span class="n">FileID</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">UInt16Col</span><span class="p">()</span>
    <span class="n">Filename</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">routine</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>


<div class="viewcode-block" id="pq_photons"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.pq_photons">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">pq_photons</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">invert_tac</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">]:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">tac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">ov</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">240</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>

        <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">inv</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ov</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">tac</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span><span class="p">)</span>
            <span class="n">ovfl</span> <span class="o">=</span> <span class="n">ov</span> <span class="o">*</span> <span class="mi">65536</span>
            <span class="n">mt</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span><span class="n">b0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ovfl</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">inv</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span><span class="p">)</span><span class="o">+</span><span class="mi">64</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">240</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>

            <span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">can</span></div>


<div class="viewcode-block" id="bh132_photons"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.bh132_photons">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">bh132_photons</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">invert_tac</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get the macros-time, micro-time and the routing channel number of a BH132-file contained in a</span>
<span class="sd">    binary numpy-array of 8-bit chars.</span>

<span class="sd">    :param b: numpy-array</span>
<span class="sd">        a numpy array of chars containing the binary information of a</span>
<span class="sd">        BH132-file</span>
<span class="sd">    :return: list</span>
<span class="sd">        a list containing the number of photons, numpy-array of macros-time (64-bit unsigned integers),</span>
<span class="sd">        numpy-array of TAC-values (32-bit unsigned integers), numpy-array of channel numbers (8-bit unsigned integers)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">tac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">ov</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">mtov</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span>
        <span class="n">mtov</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
        <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inv</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mtov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">tac</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span>
            <span class="n">ovfl</span> <span class="o">=</span> <span class="n">ov</span> <span class="o">*</span> <span class="mi">4096</span>
            <span class="n">mt</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ovfl</span>
            <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
            <span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inv</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mtov</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ov</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">event</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
                <span class="n">tac</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b2</span>
                <span class="n">ovfl</span> <span class="o">=</span> <span class="n">ov</span> <span class="o">*</span> <span class="mi">4096</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ovfl</span>
                <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
                <span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inv</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mtov</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ov</span> <span class="o">+=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">b0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">invert_tac</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">4095</span> <span class="o">-</span> <span class="n">tac</span><span class="p">,</span> <span class="n">can</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">can</span></div>


<div class="viewcode-block" id="ht3_photons"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.ht3_photons">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">ht3_photons</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">]:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">tac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">ov</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">254</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">inv</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">ov</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">tac</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span> <span class="o">|</span> <span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">252</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ovfl</span> <span class="o">=</span> <span class="n">ov</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="n">mt</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ovfl</span><span class="p">)</span>
            <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">254</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
                <span class="n">can</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">64</span>
            <span class="n">g</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">can</span></div>


<div class="viewcode-block" id="ht3_sf"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.ht3_sf">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">ht3_sf</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">stage</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">]:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">tac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">ov</span><span class="p">,</span> <span class="n">nph</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">inv</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">254</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">inv</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">ov</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">b1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">nph</span>
            <span class="n">tac</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span> <span class="o">|</span> <span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">252</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ovfl</span> <span class="o">=</span> <span class="n">ov</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="n">mt</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">b0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ovfl</span><span class="p">)</span>
            <span class="n">can</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">b3</span> <span class="o">&amp;</span> <span class="mi">254</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">can</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">61</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">64</span>
            <span class="n">nph</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">can</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">can</span><span class="p">[</span><span class="n">nph</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">can</span><span class="p">[</span><span class="n">nph</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">can</span><span class="p">[</span><span class="n">nph</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="n">nph</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">can</span></div>



<div class="viewcode-block" id="iss_16"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.iss_16">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">iss_16</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">can</span><span class="p">,</span>
        <span class="n">tac</span><span class="p">,</span>
        <span class="n">mt</span><span class="p">,</span>
        <span class="n">length</span><span class="p">,</span>
        <span class="n">step</span><span class="p">,</span>
        <span class="n">phMode</span><span class="p">,</span>
        <span class="n">offset</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reading of ISS-photon format (fcs-measurements)</span>

<span class="sd">    :param b:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">phMode</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ch1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">phMode</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch1</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch1</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">ch1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">phMode</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch1</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch2</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch1</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch2</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="iss_32"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.iss_32">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">iss_32</span><span class="p">(</span>
        <span class="n">b</span><span class="p">,</span>
        <span class="n">can</span><span class="p">,</span>
        <span class="n">tac</span><span class="p">,</span>
        <span class="n">mt</span><span class="p">,</span>
        <span class="n">length</span><span class="p">,</span>
        <span class="n">step</span><span class="p">,</span>
        <span class="n">phMode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">offset</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reading of ISS-photon format (fcs-measurements)</span>

<span class="sd">    :param data:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Data is saved as 0: 16-bit or 1: 32-bit</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">phMode</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
            <span class="n">ch1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">phMode</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch1</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch1</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">ch1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">phMode</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch1</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch2</span>
                <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch1</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch2</span><span class="p">):</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">can</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="iss_photons"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.iss_photons">[docs]</a><span class="k">def</span> <span class="nf">iss_photons</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    # CHANNEL PHOTON MODE (first 2 bytes)</span>
<span class="sd">    # in brackets int values</span>
<span class="sd">    # H (72)one channel time file_type, h (104) one channel photon file_type</span>
<span class="sd">    # X (88) two channel time file_type, x (120) two channel photon file_type</span>

<span class="sd">    :param data:</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">mfm</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">104</span><span class="p">)</span> <span class="k">else</span> <span class="mi">2</span>

    <span class="c1">#  X (88) two channel time file_type, x (120) two channel photon file_type</span>
    <span class="n">phMode</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">88</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="c1">#  Data is saved as 0: 16-bit or 1: 32-bit</span>
    <span class="n">data_32</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data_32</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ph-Mode (0/1):</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">phMode</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nbr. Ch.:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_32</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasize: 32bit&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasize: 16bit&quot;</span><span class="p">)</span>

    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">tac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_32</span><span class="p">:</span>
        <span class="c1">#k = _tttrlib.iss_32(b, can, tac, mt, length, step, phMode, offset)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">iss_32</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">can</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">phMode</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#k = _tttrlib.iss_16(b, can, tac, mt, length, step, phMode, offset)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">iss_16</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">can</span><span class="p">,</span> <span class="n">tac</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">phMode</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">mt</span><span class="p">[:</span><span class="n">k</span><span class="p">],</span> <span class="n">tac</span><span class="p">[:</span><span class="n">k</span><span class="p">],</span> <span class="n">can</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span></div>


<div class="viewcode-block" id="bh123_header"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.bh123_header">[docs]</a><span class="k">def</span> <span class="nf">bh123_header</span><span class="p">(</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="n">bHeader</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">conv8le</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">conv24be</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">65536</span><span class="p">])</span>
    <span class="n">bMTclock</span> <span class="o">=</span> <span class="n">bHeader</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bMTclock</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="n">conv8le</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bMTclock</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">conv8le</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bMTclock</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span> <span class="n">conv8le</span><span class="p">)</span>
    <span class="n">MTclock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]),</span> <span class="n">conv24be</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span>
    <span class="n">DataInvalid</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bHeader</span><span class="p">[</span><span class="mi">31</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span></div>


<div class="viewcode-block" id="iss_header"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.iss_header">[docs]</a><span class="k">def</span> <span class="nf">iss_header</span><span class="p">(</span>
        <span class="n">b</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="c1"># acquisition frequency in Hz</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">MTclock</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.e9</span>
    <span class="k">return</span> <span class="n">MTclock</span><span class="p">,</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ht3_header"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.ht3_header">[docs]</a><span class="k">def</span> <span class="nf">ht3_header</span><span class="p">(</span>
        <span class="n">b</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="c1"># TODO doesnt read header properly!!!!!</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">MTclock</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.e9</span>
    <span class="n">DataInvalid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span></div>


<div class="viewcode-block" id="make_hdf"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.make_hdf">[docs]</a><span class="k">def</span> <span class="nf">make_hdf</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new h5-file/h5-handle for photons</span>

<span class="sd">    :param title: The title of the h5-group in which new h5-photon tables are created in</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return: hdf-file handle (pytables)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mfm</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cs_settings</span><span class="p">[</span><span class="s1">&#39;photons&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]))</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s2">&quot;.photons.h5&quot;</span><span class="p">))</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">mfm</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">complib</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complib&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mfm</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cs_settings</span><span class="p">[</span><span class="s1">&#39;photons&#39;</span><span class="p">][</span><span class="s1">&#39;complib&#39;</span><span class="p">]))</span>
    <span class="n">complevel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complevel&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mfm</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cs_settings</span><span class="p">[</span><span class="s1">&#39;photons&#39;</span><span class="p">][</span><span class="s1">&#39;complevel&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Make Photon HDF-File&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Filename: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>

    <span class="n">h5</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">)</span>
    <span class="n">h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="s1">&#39;Name of measurement: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Header</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
    <span class="n">h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title</span><span class="p">,</span> <span class="s1">&#39;photons&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">Photon</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h5</span></div>


<div class="viewcode-block" id="spc2hdf"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.spc2hdf">[docs]</a><span class="k">def</span> <span class="nf">spc2hdf</span><span class="p">(</span>
        <span class="n">spc_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">routine_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bh132&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts BH-SPC files into hdf file format</span>

<span class="sd">    :param spc_files: list</span>
<span class="sd">        A list of spc-files</span>
<span class="sd">    :param routine_name:</span>
<span class="sd">        Name of the used reading routine by default &quot;bh132&quot; alternatively &quot;bh630_x48&quot;</span>
<span class="sd">    :param verbose: bool</span>
<span class="sd">        By default False</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        If the parameter &#39;filename&#39; is not provided only a temporary hdf (.h5) file is created</span>
<span class="sd">        If the parameter &#39;title&#39; is provided the data is stored in the hdf-group provided by the parameter &#39;title.</span>
<span class="sd">        Otherwise the default &#39;title&#39; spc is used to store the data within the HDF-File.</span>
<span class="sd">    :return: tables.file.File</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    If the HDF-File doesn&#39;t exist it will be created</span>

<span class="sd">    &gt;&gt;&gt; import mfm</span>
<span class="sd">    &gt;&gt;&gt; import glob</span>
<span class="sd">    &gt;&gt;&gt; directory = &quot;./sample_data/tttr/spc132/hGBP1_18D&quot;</span>
<span class="sd">    &gt;&gt;&gt; spc_files = glob.glob(directory+&#39;/*.spc&#39;)</span>
<span class="sd">    &gt;&gt;&gt; h5 = mfm.io.photons.spc2hdf(spc_files, filename=&#39;test.h5&#39;, title=&#39;hGBP1_18D&#39;)</span>

<span class="sd">    To an existing HDF-File simply a new group with the title will be created</span>

<span class="sd">    &gt;&gt;&gt; h5 = mfm.io.photons.spc2hdf(spc_files, filename=&#39;test.h5&#39;, title=&#39;hGBP1_18D_2&#39;)</span>

<span class="sd">    After finished work with the HDF-File it should be closed.</span>

<span class="sd">    &gt;&gt;&gt; h5.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">mfm</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s2">&quot;spc&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spc_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">spc_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc_files</span><span class="p">]</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">routine_name</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">routine_name</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">nTAC</span> <span class="o">=</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">routine_name</span><span class="p">][</span><span class="s1">&#39;nTAC&#39;</span><span class="p">]</span>
    <span class="n">nROUT</span> <span class="o">=</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">routine_name</span><span class="p">][</span><span class="s1">&#39;nROUT&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===========================================&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Reading routine - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">spcs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">fn_ending</span> <span class="o">=</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">routine_name</span><span class="p">][</span><span class="s1">&#39;ending&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spc_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">spc_files</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">fn_ending</span><span class="p">)):</span>
        <span class="c1"># TODO: gzip files dont work</span>
        <span class="k">with</span> <span class="n">mfm</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">zipped</span><span class="o">.</span><span class="n">open_maybe_zipped</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">spc_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">read_header</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">routine_name</span><span class="p">)</span>
            <span class="n">nPh</span><span class="p">,</span> <span class="n">aMT</span><span class="p">,</span> <span class="n">aTAC</span><span class="p">,</span> <span class="n">aROUT</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">spc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">spc_file</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
                   <span class="s1">&#39;photon&#39;</span><span class="p">:</span> <span class="p">{</span>
                       <span class="s1">&#39;ROUT&#39;</span><span class="p">:</span> <span class="n">aROUT</span><span class="p">[:</span><span class="n">nPh</span><span class="p">],</span>
                       <span class="s1">&#39;MT&#39;</span><span class="p">:</span> <span class="n">aMT</span><span class="p">[:</span><span class="n">nPh</span><span class="p">],</span>
                       <span class="s1">&#39;TAC&#39;</span><span class="p">:</span> <span class="n">aTAC</span><span class="p">[:</span><span class="n">nPh</span><span class="p">]</span>
                   <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;MT&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">spcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: reading photons...&quot;</span> <span class="o">%</span> <span class="n">spc_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Macro time clock        : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MTCLK&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Number of events        : </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;nEvents&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Total number of files: </span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spc_files</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===========================================&quot;</span><span class="p">)</span>

    <span class="n">h5</span> <span class="o">=</span> <span class="n">make_hdf</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">headertable</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">title</span><span class="o">+</span><span class="s1">&#39;/header&#39;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">headertable</span><span class="o">.</span><span class="n">row</span>
    <span class="n">photontable</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">title</span><span class="o">+</span><span class="s1">&#39;/photons&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fileID</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spcs</span><span class="p">):</span>
        <span class="c1"># Add Header</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DINV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;DINV&#39;</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NROUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nROUT</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;MTCLK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;MTCLK&#39;</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FileID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileID</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;routine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routine_name</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;nTAC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nTAC</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
        <span class="c1"># Add Photons</span>
        <span class="n">fileID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spc</span><span class="p">[</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;MT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span> <span class="o">+</span> <span class="n">fileID</span>
        <span class="n">photonA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">fileID</span><span class="p">,</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;MT&#39;</span><span class="p">],</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;ROUT&#39;</span><span class="p">],</span> <span class="n">spc</span><span class="p">[</span><span class="s1">&#39;photon&#39;</span><span class="p">][</span><span class="s1">&#39;TAC&#39;</span><span class="p">]))</span>
        <span class="n">photontable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">photonA</span><span class="p">)</span>

    <span class="n">photontable</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">ROUT</span><span class="o">.</span><span class="n">create_index</span><span class="p">()</span>
    <span class="n">h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading done!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h5</span></div>


<div class="viewcode-block" id="read_header"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.read_header">[docs]</a><span class="k">def</span> <span class="nf">read_header</span><span class="p">(</span>
        <span class="n">binary</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">routine_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the header-information of binary TTTR-files. The TTTR-files have to be</span>
<span class="sd">    passed as numpy array of type numpy.uint8</span>

<span class="sd">    :param binary:</span>
<span class="sd">        A numpy array containing the data of the SPC or HT3 files</span>
<span class="sd">    :param routine_name:</span>
<span class="sd">        either bh132 or ht3</span>
<span class="sd">    :return:</span>
<span class="sd">        An dictionary containing the most important header data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Reading Seidel-BID files</span>

<span class="sd">    &gt;&gt;&gt; import glob, mfm</span>
<span class="sd">    &gt;&gt;&gt; directory = &quot;./sample_data/tttr/spc132/hGBP1_18D&quot;</span>
<span class="sd">    &gt;&gt;&gt; spc_files = glob.glob(directory+&#39;/*.spc&#39;)</span>
<span class="sd">    &gt;&gt;&gt; b = np.fromfile(spc_files[0], dtype=np.uint8)</span>
<span class="sd">    &gt;&gt;&gt; header = mfm.io.photons.read_header(b, &#39;bh132&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(header)</span>
<span class="sd">    {&#39;MTCLK&#39;: 13.6, &#39;DINV&#39;: 0, &#39;nEvents&#39;: 1200000}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">binary</span>
    <span class="k">if</span> <span class="n">routine_name</span> <span class="o">==</span> <span class="s1">&#39;bh132&#39;</span><span class="p">:</span>
        <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tttr</span><span class="o">.</span><span class="n">bh123_header</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">routine_name</span> <span class="o">==</span> <span class="s1">&#39;iss&#39;</span><span class="p">:</span>
        <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tttr</span><span class="o">.</span><span class="n">iss_header</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">routine_name</span> <span class="o">==</span> <span class="s1">&#39;ht3&#39;</span><span class="p">:</span>
        <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tttr</span><span class="o">.</span><span class="n">ht3_header</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">MTclock</span><span class="p">,</span> <span class="n">DataInvalid</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">dHeader</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DINV&#39;</span><span class="p">:</span> <span class="n">DataInvalid</span><span class="p">,</span> <span class="s1">&#39;MTCLK&#39;</span><span class="p">:</span> <span class="n">MTclock</span><span class="p">,</span> <span class="s1">&#39;nEvents&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">dHeader</span></div>


<span class="n">filetypes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;hdf&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;High density file&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.h5&#39;</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s2">&quot;bh132&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Becker-Hickl-132&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.spc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nTAC&#39;</span><span class="p">:</span> <span class="mi">4095</span><span class="p">,</span>
        <span class="s1">&#39;nROUT&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">bh132_photons</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s2">&quot;ht3&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;PicoQuant-ht3&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.ht3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nTAC&#39;</span><span class="p">:</span> <span class="mi">65535</span><span class="p">,</span>
        <span class="s1">&#39;nROUT&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">ht3_photons</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s2">&quot;ht3c&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Suren ht3 compressed&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.ht3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nTAC&#39;</span><span class="p">:</span> <span class="mi">65535</span><span class="p">,</span>
        <span class="s1">&#39;nROUT&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">ht3_sf</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s2">&quot;ptu&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;PicoQuant-PTU&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.ptu&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nTAC&#39;</span><span class="p">:</span> <span class="mi">65535</span><span class="p">,</span>
        <span class="s1">&#39;nROUT&#39;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">pq_photons</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s2">&quot;iss&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;ISS-fcs&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ending&#39;</span><span class="p">:</span> <span class="s1">&#39;.fcs&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nTAC&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;nROUT&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">iss_photons</span>
    <span class="p">})</span>
<span class="p">]</span>
<span class="p">)</span>


<div class="viewcode-block" id="read_hht3"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.read_hht3">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_hht3</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">n_rec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">):</span>

    <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">overflow_correction</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nph</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">t3_wrap</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b00000000000000000000001111111111</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b00000001111111111111110000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b01111110000000000000000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b10000000000000000000000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span>

        <span class="k">if</span> <span class="n">sp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="mb">0b111111</span><span class="p">:</span>  <span class="c1"># overflow of nsync occured</span>
                <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">overflow_correction</span> <span class="o">+=</span> <span class="n">t3_wrap</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">overflow_correction</span> <span class="o">+=</span> <span class="n">t3_wrap</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">):</span>  <span class="c1"># these are markers</span>
                <span class="n">true_n_sync</span> <span class="o">=</span> <span class="n">overflow_correction</span> <span class="o">+</span> <span class="n">ns</span>

                <span class="n">mt</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_n_sync</span>
                <span class="n">cn</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">sb</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span>
                <span class="n">nph</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this means a regular input channel</span>
            <span class="n">true_n_sync</span> <span class="o">=</span> <span class="n">overflow_correction</span> <span class="o">+</span> <span class="n">ns</span>

            <span class="n">mt</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_n_sync</span>
            <span class="n">mi</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">cn</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
            <span class="n">sb</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span>
            <span class="n">nph</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">sb</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">mt</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">mi</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">cn</span><span class="p">[:</span><span class="n">nph</span><span class="p">]</span></div>


<div class="viewcode-block" id="read_pht3"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.read_pht3">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_pht3</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">n_rec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">):</span>

    <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">nph</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t3_wrap</span> <span class="o">=</span> <span class="mi">65536</span>
    <span class="n">over_flow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b00000000000000001111111111111111</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b00001111111111110000000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b11110000000000000000000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="mb">0b1111</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">n_sync</span> <span class="o">=</span> <span class="n">over_flow</span> <span class="o">+</span> <span class="n">ns</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">mt</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sync</span>
            <span class="n">mi</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">cn</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">sb</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span>
            <span class="n">nph</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">over_flow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sp</span><span class="p">:</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span> <span class="o">&amp;</span> <span class="mb">0b00000000000011110000000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
                <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">over_flow</span> <span class="o">+=</span> <span class="n">t3_wrap</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mt</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sync</span>
                    <span class="n">mi</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="n">cn</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">marker</span>
                    <span class="n">sb</span><span class="p">[</span><span class="n">nph</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span>
                    <span class="n">nph</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># This is an error</span>

    <span class="k">return</span> <span class="n">sb</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">mt</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">mi</span><span class="p">[:</span><span class="n">nph</span><span class="p">],</span> <span class="n">cn</span><span class="p">[:</span><span class="n">nph</span><span class="p">]</span></div>



<span class="n">pq_tag_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xFFFF0008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyEmpty8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">},</span>
    <span class="mh">0x00000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyBool8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">},</span>
    <span class="mh">0x10000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyInt8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">},</span>
    <span class="mh">0x11000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyBitSet64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">},</span>
    <span class="mh">0x12000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyColor8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">},</span>
    <span class="mh">0x20000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyFloat8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">},</span>
    <span class="mh">0x21000008</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyTDateTime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">},</span>
    <span class="mh">0x2001FFFF</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyFloat8Array&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s1">&#39;sub_type&#39;</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">},</span>
    <span class="mh">0x4001FFFF</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyAnsiString&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s1">&#39;sub_type&#39;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">},</span>
    <span class="mh">0x4002FFFF</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyWideString&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s1">&#39;sub_type&#39;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">},</span>
    <span class="mh">0xFFFFFFFF</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;tyBinaryBlob&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s1">&#39;sub_type&#39;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="n">pq_hardware</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x01010304</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtHydraHarp2T3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;HydraHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">read_hht3</span>
    <span class="p">},</span>

    <span class="mh">0x00010303</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtPicoHarpT3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;PicoHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">read_pht3</span>
    <span class="p">},</span>
    <span class="mh">0x00010203</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtPicoHarpT2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;PicoHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x00010304</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtHydraHarpT3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;HydraHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">read_hht3</span>
    <span class="p">},</span>
    <span class="mh">0x00010204</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtHydraHarpT2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;HydraHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x01010204</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtHydraHarp2T2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;HydraHarp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x00010305</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtTimeHarp260NT3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;TimeHarp260N&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x00010205</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtTimeHarp260NT2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;TimeHarp260N&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x00010306</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtTimeHarp260PT3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;TimeHarp260P&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">},</span>
    <span class="mh">0x00010206</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rtTimeHarp260PT2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HW&#39;</span><span class="p">:</span> <span class="s1">&#39;TimeHarp260P&#39;</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
<span class="p">}</span>


<div class="viewcode-block" id="read_ptu"><a class="viewcode-back" href="../../../api/mfm.io.html#mfm.io.tttr.read_ptu">[docs]</a><span class="k">def</span> <span class="nf">read_ptu</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reads a PicoQuant PTU-file</span>
<span class="sd">    </span>
<span class="sd">    :param filename:</span>
<span class="sd">    :return: </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import pylab as p</span>
<span class="sd">    &gt;&gt;&gt; filename = &#39;C://temp/PQSpcm_2017-04-20_13-23-53.ptu&#39;</span>
<span class="sd">    &gt;&gt;&gt; filename = &quot;N:/STED_microscope/2017/04/21/PQSpcm_2017-04-21_11-03-37.ptu&quot;</span>
<span class="sd">    &gt;&gt;&gt; r = read_ptu(filename)</span>
<span class="sd">    &gt;&gt;&gt; y, x = np.histogram(r[&#39;micro_time&#39;], bins=range(0, 4096))</span>
<span class="sd">    &gt;&gt;&gt; p.semilogy(x[1:], y+1)</span>
<span class="sd">    &gt;&gt;&gt; p.show()</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">magic</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">==</span> <span class="s1">&#39;PQTTTR&#39;</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s1">&#39;32s i I q&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">TagIdent</span><span class="p">,</span> <span class="n">TagIdx</span><span class="p">,</span> <span class="n">TagType</span><span class="p">,</span> <span class="n">TagValue</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="n">TagIdent</span> <span class="o">=</span> <span class="n">TagIdent</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TagIdx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">TagIdent</span> <span class="o">+=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">TagIdx</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="n">pq_tag_types</span><span class="p">[</span><span class="n">TagType</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">TagValue</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rt</span><span class="p">[</span><span class="s1">&#39;sub_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">rt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">](</span><span class="n">TagValue</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TagIdent</span> <span class="o">==</span> <span class="s2">&quot;Header_End&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tags</span><span class="p">[</span><span class="n">TagIdent</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">hw</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;TTResultFormat_TTTRRecType&#39;</span><span class="p">]</span>
            <span class="n">n_rec</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;TTResult_NumberOfRecords&quot;</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">read</span> <span class="o">=</span> <span class="n">pq_hardware</span><span class="p">[</span><span class="n">hw</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">pq_hardware</span><span class="p">[</span><span class="n">hw</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_rec</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                      <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
                      <span class="n">special_bits</span><span class="o">=</span><span class="n">t3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">macro_time</span><span class="o">=</span><span class="n">t3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">micro_time</span><span class="o">=</span><span class="n">t3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                      <span class="n">channel</span><span class="o">=</span><span class="n">t3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">rt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No PTU file&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not found.&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Thomas Peulen

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>