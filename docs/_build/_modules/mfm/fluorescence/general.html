<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>mfm.fluorescence.general &#8212; ChiSurf  documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          ChiSurf</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation/use_cases.html">Use cases</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for mfm.fluorescence.general</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">scipy.optimize</span>

<span class="kn">import</span> <span class="nn">mfm.math.datatools</span>

<span class="n">rate2lifetime</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rate</span><span class="p">,</span> <span class="n">lifetime</span><span class="p">:</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;1. / (1. / lifetime + rate)&quot;</span><span class="p">)</span>
<span class="n">et</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fd0</span><span class="p">,</span> <span class="n">fda</span><span class="p">:</span> <span class="n">fda</span> <span class="o">/</span> <span class="n">fd0</span>


<div class="viewcode-block" id="fretrate_to_distance"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.fretrate_to_distance">[docs]</a><span class="k">def</span> <span class="nf">fretrate_to_distance</span><span class="p">(</span><span class="n">fretrate</span><span class="p">,</span> <span class="n">forster_radius</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">kappa2</span><span class="o">=</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the distance given a FRET-rate</span>

<span class="sd">    :param fretrate: FRET-rate</span>
<span class="sd">    :param forster_radius: Forster radius</span>
<span class="sd">    :param tau0: lifetime of the donor</span>
<span class="sd">    :param kappa2: orientation factor</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">forster_radius</span> <span class="o">*</span> <span class="p">(</span><span class="n">fretrate</span> <span class="o">*</span> <span class="n">tau0</span><span class="o">/</span><span class="n">kappa2</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span></div>


<div class="viewcode-block" id="species_averaged_lifetime"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.species_averaged_lifetime">[docs]</a><span class="k">def</span> <span class="nf">species_averaged_lifetime</span><span class="p">(</span>
        <span class="n">fluorescence</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_lifetime_spectrum</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the species averaged lifetime given a lifetime spectrum</span>

<span class="sd">    :param fluorescence: either a inter-leaved lifetime-spectrum (if is_lifetime_spectrum is True) or a </span>
<span class="sd">        fluorescence decay (times, fluorescence intensity)</span>
<span class="sd">    :param normalize:</span>
<span class="sd">    :param is_lifetime_spectrum:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_lifetime_spectrum</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">interleaved_to_two_columns</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">/=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">tau_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">tau_x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">fluorescence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">fluorescence</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span></div>


<div class="viewcode-block" id="fluorescence_averaged_lifetime"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.fluorescence_averaged_lifetime">[docs]</a><span class="k">def</span> <span class="nf">fluorescence_averaged_lifetime</span><span class="p">(</span>
        <span class="n">fluorescence</span><span class="p">,</span>
        <span class="n">taux</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_lifetime_spectrum</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param fluorescence: interleaved lifetime spectrum</span>
<span class="sd">    :param taux: float</span>
<span class="sd">        The species averaged lifetime. If this value is not provided it is calculated based</span>
<span class="sd">        on th lifetime spectrum</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_lifetime_spectrum</span><span class="p">:</span>
        <span class="n">taux</span> <span class="o">=</span> <span class="n">species_averaged_lifetime</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">)</span> <span class="k">if</span> <span class="n">taux</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">taux</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">interleaved_to_two_columns</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">/=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">tau_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">taux</span>
        <span class="k">return</span> <span class="n">tau_f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">fluorescence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">fluorescence</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intensity</span> <span class="o">*</span> <span class="n">time_axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span></div>


<div class="viewcode-block" id="distance_to_fret_rate_constant"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.distance_to_fret_rate_constant">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">distance_to_fret_rate_constant</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">forster_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tau0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">kappa2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Converts the DA-distance to a FRET-rate</span>

<span class="sd">    :param r: donor-acceptor distance</span>
<span class="sd">    :param forster_radius: Forster-radius</span>
<span class="sd">    :param tau0: lifetime</span>
<span class="sd">    :param kappa2: orientation factor</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">kappa2</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">tau0</span> <span class="o">*</span> <span class="p">(</span><span class="n">forster_radius</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="mf">6.0</span></div>


<div class="viewcode-block" id="distance_to_fret_efficiency"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.distance_to_fret_efficiency">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">distance_to_fret_efficiency</span><span class="p">(</span>
        <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">forster_radius</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>

<span class="sd">        E = 1.0 / (1.0 + (R_{DA} / R_0)^6)</span>

<span class="sd">    :param distance: DA-distance</span>
<span class="sd">    :param forster_radius: Forster-radius</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">forster_radius</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span></div>


<div class="viewcode-block" id="lifetime_to_fret_efficiency"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.lifetime_to_fret_efficiency">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">lifetime_to_fret_efficiency</span><span class="p">(</span>
        <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tau0</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>

<span class="sd">        E = 1 - tau / tau_0</span>

<span class="sd">    :param tau: fluorescence lifetime in the presence of FRET</span>
<span class="sd">    :param tau0: fluorescence lifetime in the absence of FRET</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span> <span class="o">/</span> <span class="n">tau0</span></div>


<div class="viewcode-block" id="fret_efficiency_to_distance"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.fret_efficiency_to_distance">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">fret_efficiency_to_distance</span><span class="p">(</span>
        <span class="n">fret_efficiency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">forster_radius</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the transfer-efficiency to a distance</span>

<span class="sd">    .. math::</span>

<span class="sd">        R_{DA} = R_0 (1 / E - 1)^{1/6}</span>

<span class="sd">    :param fret_efficiency: Transfer-efficency</span>
<span class="sd">    :param forster_radius: Forster-radius</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">fret_efficiency</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">forster_radius</span></div>


<div class="viewcode-block" id="fret_efficiency_to_lifetime"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.fret_efficiency_to_lifetime">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">fret_efficiency_to_lifetime</span><span class="p">(</span>
        <span class="n">fret_efficiency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tau0</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>

<span class="sd">        tau_{DA} = (1 - E) * tau_0</span>

<span class="sd">    :param fret_efficiency:</span>
<span class="sd">    :param tau0:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fret_efficiency</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau0</span></div>


<div class="viewcode-block" id="transfer_space"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.transfer_space">[docs]</a><span class="k">def</span> <span class="nf">transfer_space</span><span class="p">(</span>
        <span class="n">transfer_efficiency_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">transfer_efficiency_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">forster_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">52.0</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates distances with equally spaced transfer efficiencies</span>

<span class="sd">    :param transfer_efficiency_min: float</span>
<span class="sd">        minimum transfer efficency</span>
<span class="sd">    :param transfer_efficiency_max: float</span>
<span class="sd">        maximum transfer efficency</span>
<span class="sd">    :param n_steps: int</span>
<span class="sd">        number of distances</span>
<span class="sd">    :param forster_radius: float</span>
<span class="sd">        Forster-radius</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">transfer_efficiency_min</span><span class="p">,</span> <span class="n">transfer_efficiency_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="n">rdas</span> <span class="o">=</span> <span class="n">fret_efficiency_to_distance</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">forster_radius</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rdas</span></div>


<div class="viewcode-block" id="calc_transfer_matrix"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.calc_transfer_matrix">[docs]</a><span class="k">def</span> <span class="nf">calc_transfer_matrix</span><span class="p">(</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">rDA_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">rDA_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">kappa2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.667</span><span class="p">,</span>
        <span class="n">space</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lin&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a matrix converting a distance distribution to an E(t)-decay</span>

<span class="sd">    :param times:</span>
<span class="sd">    :param rDA_min:</span>
<span class="sd">    :param rDA_max:</span>
<span class="sd">    :param n_steps:</span>
<span class="sd">    :param kappa2:</span>
<span class="sd">    :param log_space:</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        tau0 - lifetime,</span>
<span class="sd">        R0 - Forster-radius,</span>
<span class="sd">        n_donor_bins: int (default 10)</span>
<span class="sd">            the number of bins with rate 0.0 (Donor-only). The longest distances are</span>
<span class="sd">            replaced by zero-rates</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; times = np.arange(0, 20, 0.0141)</span>
<span class="sd">    &gt;&gt;&gt; m, r_da = calc_transfer_matrix(times)</span>

<span class="sd">    .. plot:: plots/e_transfer_matrix.py</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;R0&#39;</span><span class="p">,</span> <span class="mf">52.0</span><span class="p">)</span>
    <span class="n">tau0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tau0&#39;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
    <span class="n">r_DA</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_DA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">n_donor_bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_donor_bins&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r_DA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
            <span class="n">r_DA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rDA_min</span><span class="p">,</span> <span class="n">rDA_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">lmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rDA_min</span><span class="p">)</span>
            <span class="n">lmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rDA_max</span><span class="p">)</span>
            <span class="n">r_DA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;trans&#39;</span><span class="p">:</span>
            <span class="n">e_min</span> <span class="o">=</span> <span class="n">distance_to_fret_efficiency</span><span class="p">(</span><span class="n">rDA_min</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span>
            <span class="n">e_max</span> <span class="o">=</span> <span class="n">distance_to_fret_efficiency</span><span class="p">(</span><span class="n">rDA_max</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span>
            <span class="n">r_DA</span> <span class="o">=</span> <span class="n">transfer_space</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span>

    <span class="n">rates</span> <span class="o">=</span> <span class="n">distance_to_fret_rate_constant</span><span class="p">(</span>
        <span class="n">r_DA</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">kappa2</span>
    <span class="p">)</span>
    <span class="c1"># Use the last bins for D-Only</span>
    <span class="n">rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">n_donor_bins</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">r_DA</span></div>


<div class="viewcode-block" id="calc_decay_matrix"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.calc_decay_matrix">[docs]</a><span class="k">def</span> <span class="nf">calc_decay_matrix</span><span class="p">(</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">tau_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">tau_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">space</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lin&#39;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a fluorescence decay matrix converting probabilities of lifetimes to a time-resolved</span>
<span class="sd">    fluorescence intensity</span>

<span class="sd">    :param t:</span>
<span class="sd">    :param tau_min:</span>
<span class="sd">    :param tau_max:</span>
<span class="sd">    :param n_steps:</span>
<span class="sd">    :param space:</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; times = np.arange(0, 20, 0.0141)</span>
<span class="sd">    &gt;&gt;&gt; m, r_da = calc_decay_matrix(times)</span>

<span class="sd">    Now plot the decay matrix</span>

<span class="sd">    &gt;&gt;&gt; import pylab as p</span>
<span class="sd">    &gt;&gt;&gt; p.imshow(m)</span>
<span class="sd">    &gt;&gt;&gt; p.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tau_min</span><span class="p">,</span> <span class="n">tau_max</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">lmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tau_min</span><span class="p">)</span>
        <span class="n">lmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tau_max</span><span class="p">)</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">taus</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">taus</span></div>


<div class="viewcode-block" id="et2pRDA"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.et2pRDA">[docs]</a><span class="k">def</span> <span class="nf">et2pRDA</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span>
        <span class="n">et</span><span class="p">,</span>
        <span class="n">t_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">r_DA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the distance distribution given an E(t) decay</span>
<span class="sd">    Here the amplitudes of E(t) are passed as well as the time-axis. If no transfer-matrix is provided it will</span>
<span class="sd">    be calculated in a range from 5 Ang to 200 Ang assuming a lifetime of 4 ns with a Forster-radius of 52 Ang.</span>
<span class="sd">    These parameters can be provided by *kwargs*</span>

<span class="sd">    :param t:</span>
<span class="sd">    :param et:</span>
<span class="sd">    :param t_matrix:</span>
<span class="sd">    :param r_DA:</span>
<span class="sd">    :param kwargs: tau0 donor-lifetime in absence of quenching, R0 - Forster-Radius</span>
<span class="sd">    :return: a distance and probability array</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    First calculate an E(t)-decay</span>

<span class="sd">    &gt;&gt;&gt; rda_mean = [45.1, 65.0]</span>
<span class="sd">    &gt;&gt;&gt; rda_sigma = [8.0, 8.0]</span>
<span class="sd">    &gt;&gt;&gt; amplitudes = [0.6, 0.4]</span>
<span class="sd">    &gt;&gt;&gt; rates = gaussian2rates(rda_mean, rda_sigma, amplitudes, interleaved=False)</span>
<span class="sd">    &gt;&gt;&gt; a = rates[:,0]</span>
<span class="sd">    &gt;&gt;&gt; kFRET = rates[:,1]</span>
<span class="sd">    &gt;&gt;&gt; ts = np.logspace(0.1, 3, 18000)</span>
<span class="sd">    &gt;&gt;&gt; et = np.array([np.dot(a, np.exp(-kFRET * times)) for times in ts])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t_matrix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_DA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_matrix</span><span class="p">,</span> <span class="n">r_DA</span> <span class="o">=</span> <span class="n">calc_transfer_matrix</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">p_rDA</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">nnls</span><span class="p">(</span><span class="n">t_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">et</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">r_DA</span><span class="p">,</span> <span class="n">p_rDA</span></div>


<div class="viewcode-block" id="stack_lifetime_spectra"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.stack_lifetime_spectra">[docs]</a><span class="k">def</span> <span class="nf">stack_lifetime_spectra</span><span class="p">(</span>
        <span class="n">lifetime_spectra</span><span class="p">,</span>
        <span class="n">fractions</span><span class="p">,</span>
        <span class="n">normalize_fractions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an array of lifetime spectra and an array of fractions and returns an mixed array of lifetimes</span>
<span class="sd">    whereas the amplitudes are multiplied by the fractions. `normalize_fractions` is True the fractions</span>
<span class="sd">    are normalized to one.</span>

<span class="sd">    :return: numpy-array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span> <span class="k">if</span> <span class="n">normalize_fractions</span> <span class="k">else</span> <span class="n">fractions</span>
    <span class="n">re</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lifetime_spectra</span><span class="p">):</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
        <span class="n">ls</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">fn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">re</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">re</span><span class="p">)</span></div>


<div class="viewcode-block" id="distribution2rates"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.distribution2rates">[docs]</a><span class="k">def</span> <span class="nf">distribution2rates</span><span class="p">(</span>
        <span class="n">distribution</span><span class="p">,</span>
        <span class="n">tau0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">kappa2</span><span class="p">,</span>
        <span class="n">forster_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">remove_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    gets distribution in form: (1,2,3)</span>
<span class="sd">    0: number of distribution</span>
<span class="sd">    1: amplitude</span>
<span class="sd">    2: distance</span>

<span class="sd">    returns:</span>
<span class="sd">    0: number of dist</span>
<span class="sd">    1: amplitude</span>
<span class="sd">    2: rate</span>

<span class="sd">    :param distribution:</span>
<span class="sd">    :param tau0:</span>
<span class="sd">    :param kappa2: a interleaved list of orientation factors (orientation factor spectrum)</span>
<span class="sd">    :param forster_radius:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_dist</span><span class="p">,</span> <span class="n">n_ampl</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rate_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">distribution</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_negative</span><span class="p">:</span>
        <span class="n">rate_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rate_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dist</span><span class="p">):</span>
        <span class="n">rate_dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_to_fret_rate_constant</span><span class="p">(</span>
            <span class="n">rate_dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">forster_radius</span><span class="p">,</span>
            <span class="n">tau0</span><span class="p">,</span>
            <span class="mf">0.66667</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">rate_dist</span></div>
    <span class="c1">#</span>
    <span class="c1"># k2 = kappa2.reshape((len(kappa2)/2, 2))</span>
    <span class="c1"># k2_amp = k2[:, 0]</span>
    <span class="c1"># k2_val = k2[:, 1]</span>
    <span class="c1"># rate_const = np.outer(k2_val, rate_dist[:, 0]).flatten()</span>
    <span class="c1"># amplitudes = np.outer(k2_amp, rate_dist[:, 1]).flatten()</span>
    <span class="c1">#</span>
    <span class="c1"># c = np.empty((1, 2, rate_const.size), dtype=rate_const.dtype)</span>
    <span class="c1"># c[:, 0] = amplitudes</span>
    <span class="c1"># c[:, 1] = rate_const</span>
    <span class="c1"># print(&quot;c-shape&quot;)</span>
    <span class="c1"># print(c.shape)</span>
    <span class="c1"># return c</span>


<div class="viewcode-block" id="gaussian2rates"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.gaussian2rates">[docs]</a><span class="k">def</span> <span class="nf">gaussian2rates</span><span class="p">(</span>
        <span class="n">means</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">sigmas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">amplitudes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">tau0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="n">kappa2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.667</span><span class="p">,</span>
        <span class="n">R0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">52.0</span><span class="p">,</span>
        <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">m_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">interleaved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate distribution of FRET-rates given a list of normal/Gaussian distributed</span>
<span class="sd">    distances.</span>

<span class="sd">    :param means:</span>
<span class="sd">    :param sigmas:</span>
<span class="sd">    :param amplitudes:</span>
<span class="sd">    :param tau0:</span>
<span class="sd">    :param kappa2:</span>
<span class="sd">    :param R0:</span>
<span class="sd">    :param n_points:</span>
<span class="sd">    :param m_sigma:</span>
<span class="sd">    :param interleaved:</span>
<span class="sd">    :return:</span>

<span class="sd">    :return: either an interleaved rate-spectrum, or a 2D-array stack</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    This generates an interleaved array here it follows the *rule*:</span>
<span class="sd">    amplitude, rate, amplitude, rate, ...</span>

<span class="sd">    &gt;&gt;&gt; gaussian2rates([50], [8.0], [1.0], interleaved=True, n_points=8)</span>
<span class="sd">    array([ 0.06060222,  1.64238732,  0.10514622,  0.97808684,  0.1518205 ,</span>
<span class="sd">            0.60699836,  0.18243106,  0.39018018,  0.18243106,  0.25853181,</span>
<span class="sd">            0.1518205 ,  0.17589017,  0.10514622,  0.12247918,  0.06060222,</span>
<span class="sd">            0.08706168])</span>

<span class="sd">    If *interleaved* is False a 2D-numpy array is returned. The first dimension corresponds</span>
<span class="sd">    to the amplitudes the second to the rates.</span>

<span class="sd">    &gt;&gt;&gt; gaussian2rates([50], [8.0], [1.0], interleaved=False, n_points=8)</span>
<span class="sd">    array([[ 0.06060222,  1.64238732],</span>
<span class="sd">           [ 0.10514622,  0.97808684],</span>
<span class="sd">           [ 0.1518205 ,  0.60699836],</span>
<span class="sd">           [ 0.18243106,  0.39018018],</span>
<span class="sd">           [ 0.18243106,  0.25853181],</span>
<span class="sd">           [ 0.1518205 ,  0.17589017],</span>
<span class="sd">           [ 0.10514622,  0.12247918],</span>
<span class="sd">           [ 0.06060222,  0.08706168]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">n_gauss</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_gauss</span><span class="p">,</span> <span class="n">n_points</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gauss</span><span class="p">):</span>
        <span class="n">g_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_sigma</span> <span class="o">*</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">g_max</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">m_sigma</span> <span class="o">*</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">g_min</span><span class="p">,</span> <span class="n">g_max</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">bins</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">amplitudes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_to_fret_rate_constant</span><span class="p">(</span>
            <span class="n">bins</span><span class="p">,</span>
            <span class="n">R0</span><span class="p">,</span>
            <span class="n">tau0</span><span class="p">,</span>
            <span class="mf">0.66667</span>
        <span class="p">)</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">interleaved</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">ps</span><span class="p">,</span> <span class="n">ls</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">ps</span><span class="p">,</span> <span class="n">ls</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="rates2lifetimes_old"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.rates2lifetimes_old">[docs]</a><span class="k">def</span> <span class="nf">rates2lifetimes_old</span><span class="p">(</span>
        <span class="n">rates</span><span class="p">,</span>
        <span class="n">donors</span><span class="p">,</span>
        <span class="n">x_donly</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an interleaved rate spectrum to an interleaved lifetime spectrum</span>
<span class="sd">    given an interleaved donor spectrum and the fraction of donor-only</span>

<span class="sd">    :param rates: numpy-array</span>
<span class="sd">    :param donors: numpy-array</span>
<span class="sd">    :param x_donly: float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_donors</span> <span class="o">=</span> <span class="n">donors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">n_rates</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>

    <span class="n">pd</span><span class="p">,</span> <span class="n">ld</span> <span class="o">=</span> <span class="n">donors</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_donors</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pr</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_rates</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># allocated memory</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_donors</span><span class="p">,</span> <span class="n">n_rates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>

    <span class="n">x_fret</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x_donly</span><span class="p">)</span>
    <span class="c1">## Quench donor ##</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_donors</span><span class="p">):</span>
        <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">pr</span> <span class="o">*</span> <span class="n">x_fret</span>
        <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate2lifetime</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ld</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">gl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">ps</span><span class="p">,</span> <span class="n">ls</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x_donly</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">donor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">pd</span> <span class="o">*</span> <span class="n">x_donly</span><span class="p">,</span> <span class="n">ld</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">gl</span><span class="p">,</span> <span class="n">donor</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gl</span></div>


<div class="viewcode-block" id="rates2lifetimes_new"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.rates2lifetimes_new">[docs]</a><span class="k">def</span> <span class="nf">rates2lifetimes_new</span><span class="p">(</span>
        <span class="n">fret_rate_spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">donor_rate_spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">x_donly</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts an interleaved rate spectrum to an interleaved lifetime spectrum</span>
<span class="sd">    given an interleaved donor spectrum and the fraction of donor-only</span>

<span class="sd">    :param fret_rate_spectrum: numpy-array</span>
<span class="sd">    :param donor_rate_spectrum: numpy-array</span>
<span class="sd">    :param x_donly: float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rate_spectrum</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">ere2</span><span class="p">(</span><span class="n">fret_rate_spectrum</span><span class="p">,</span> <span class="n">donor_rate_spectrum</span><span class="p">)</span>
    <span class="n">scaled_fret</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">e1tn</span><span class="p">(</span><span class="n">rate_spectrum</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">x_donly</span><span class="p">)</span>
    <span class="n">scaled_donor</span> <span class="o">=</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">e1tn</span><span class="p">(</span><span class="n">donor_rate_spectrum</span><span class="p">,</span> <span class="n">x_donly</span><span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaled_fret</span><span class="p">,</span> <span class="n">scaled_donor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mfm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">datatools</span><span class="o">.</span><span class="n">invert_interleaved</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span></div>

<span class="n">rates2lifetimes</span> <span class="o">=</span> <span class="n">rates2lifetimes_new</span>


<div class="viewcode-block" id="calculate_fluorescence_decay"><a class="viewcode-back" href="../../../user_documentation/api/fluorescence.html#mfm.fluorescence.general.calculate_fluorescence_decay">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">calculate_fluorescence_decay</span><span class="p">(</span>
        <span class="n">lifetime_spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">time_axis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a interleaved lifetime spectrum into a intensity decay</span>

<span class="sd">    :param lifetime_spectrum: interleaved lifetime spectrum</span>
<span class="sd">    :param time_axis: time-axis</span>
<span class="sd">    :return:</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; time_axis = np.linspace(0, 20, num=100)</span>
<span class="sd">    &gt;&gt;&gt; structure = mfm.structure.Structure(&#39;./sample_data/modelling/pdb_files/hGBP1_closed.pdb&#39;)</span>
<span class="sd">    &gt;&gt;&gt; donor_description = {&#39;residue_seq_number&#39;: 344, &#39;atom_name&#39;: &#39;CB&#39;}</span>
<span class="sd">    &gt;&gt;&gt; acceptor_description = {&#39;residue_seq_number&#39;: 496, &#39;atom_name&#39;: &#39;CB&#39;}</span>
<span class="sd">    &gt;&gt;&gt; donor_lifetime_spectrum = np.array([1., 4.])</span>
<span class="sd">    &gt;&gt;&gt; lifetime_spectrum = structure.av_lifetime_spectrum(donor_lifetime_spectrum, donor_description, acceptor_description)</span>
<span class="sd">    &gt;&gt;&gt; time_axis, decay = calculate_fluorescence_decay(lifetime_spectrum, time_axis)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">decay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">time_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">lifetime_spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">am</span> <span class="o">/=</span> <span class="n">am</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">lifetime_spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">lifetime</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">am</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lifetime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">decay</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_axis</span> <span class="o">/</span> <span class="n">lifetime</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplitude</span>
    <span class="k">return</span> <span class="n">time_axis</span><span class="p">,</span> <span class="n">decay</span></div>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Thomas Peulen.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>